# CHANGELOG

## [1.2.1.2] – 08.10.2025

### Добавлено

- **Виртуальные интерфейсы** для агрегирования трафика:
  - `vpn` теперь суммирует: `vpn` + `vpn-udp` + `vpn-tcp`.
  - `antizapret` теперь суммирует: `antizapret` + `antizapret-upd` + `antizapret-tcp`.
- Поддержка параллельной загрузки и **комбинирования рядов** (labels, rx/tx) с выравниванием меток времени.
- **Totals** за периоды (`1d`, `7d`, `30d`) также суммируются для групп.
- Добавлены **кнопки переключения единиц измерения трафика** между мегабайтами (MB) и мегабитами (Mb).

## [1.2.1] – 08.10.2025

### Добавлено

- **Автоопределение сетевого интерфейса при установке**:

  - Получение списка доступных интерфейсов через `ip link show` с фильтрацией (`lo`, `docker`, `veth`, `br-`, `vpn`, `antizapret`, `tun`, `tap`).
  - Определение интерфейса по умолчанию из `ip route | grep default`; при отсутствии — используется `eth0`.
  - Автоматический выбор интерфейса, если найден ровно один.
  - Интерактивный выбор интерфейса при наличии нескольких (с проверкой существования через `ip link show`).
  - Сохранение выбранного интерфейса в `.env`:
    ```
    VNSTAT_IFACE=<iface>
    ```

- **Интеграция с веб-интерфейсом**:
  - В шаблон `server_monitor.html` теперь передаётся переменная `iface` (значение из `.env` или `ens3` по умолчанию).

### Изменено

- Обновлена логика установки — теперь интерфейс определяется и сохраняется автоматически для корректной работы `vnstat` и веб-интерфейса.

### Примечание

- После обновления обязательно запустить:
  ```bash
  /opt/AdminAntizapret/script_sh/fix_vnstat.sh
  ```
  для корректного применения изменений и обновления конфигурации vnstat.

## [1.2.0] – 07.10.2025

### Новое

- Добавлен раздел **«Загрузка канала»** в `server_monitor.html`.  
  Теперь можно:
  - Переключать сетевые интерфейсы: `ens3`, `vpn`, `antizapret`;
  - Выбирать период: `1 день`, `7 дней`, `30 дней`;
  - Смотреть график скорости и объёма трафика (на основе **Chart.js**);
  - Видеть текущую нагрузку (Rx / Tx) и суммарные данные за периоды.
- Выбранный интерфейс и диапазон теперь сохраняются в браузере (через `localStorage`).

### Изменения

- Весь JavaScript и CSS для мониторинга вынесен из `server_monitor.html`  
  в отдельные файлы:
  - `server_monitor.js`
  - `server_monitor.css`
- Кнопки выбора диапазона и интерфейса стали удобнее — активная подсвечивается, остальные недоступны.

## [1.1.9] - 04-10-2025

### Добавлено

- **Поддержка указания хостов для VPN**:

  - `OPENVPN_HOST` — ввод доменного имени для OpenVPN сервера (требует пересоздания конфигураций).
  - `WIREGUARD_HOST` — ввод доменного имени для WireGuard сервера (требует пересоздания конфигураций).

- **Управление дополнительными параметрами через веб-интерфейс**:

  - **Новый переключатель фильтрации доменов казино**:
    - `CLEAR_HOSTS` — опция в интерфейсе, позволяющая включить/отключить удаление ~170 000 доменов азартных игр при автообновлении списков.
  - Заголовок секции обновлён: теперь «Дополнительные фильтры для Antizapret».

- **Улучшения интерфейса Antizapret**:

  - Обновлённые описания параметров (Cloudflare, Google, Telegram, Amazon и др.).
  - Единый стиль блоков (`AZ`, `OVPN`, `WG`, `Server`) для удобства восприятия.

- **Расширенные сетевые защиты**:

  - Визуальное разделение на колонки (SSH защита, Torrent Guard, Антискан, Ограничение форвардинга).

- **Улучшения UX**:
  - Подсказки и пояснения вынесены в отдельные тултипы.
  - Блоки настроек получили группировку и иконки для удобной навигации.

## [1.1.8] - 29-09-2025

### Добавлено

- **Управление дополнительными параметрами через веб-интерфейс**:
  - Новый раздел **«Резервные OpenVPN-порты (80/443)»**:
    - `OPENVPN_80_443_TCP` — включение резервного подключения OpenVPN через TCP 80/443
    - `OPENVPN_80_443_UDP` — включение резервного подключения OpenVPN через UDP 80/443
  - Новый блок **«Сетевые защиты»**:
    - `SSH_PROTECTION` — защита от брутфорса SSH (ограничение 3 новых подключений в час с одного IP)
    - `ATTACK_PROTECTION` — антискан и защита от сетевых атак (может блокировать VPN или сторонние приложения)
    - `TORRENT_GUARD` — блокировка VPN на 1 минуту при обнаружении торрентов (для хостеров, запрещающих торрент-трафик)
    - `RESTRICT_FORWARD` — ограничение форвардинга: через AntiZapret VPN идут только IP из `forward-ips.txt` и `route-ips.txt`

## [1.1.7] - 27-09-2025

### Добавлено

- **Поддержка новых форматов имён конфигурационных файлов**:
  - Для файлов с суффиксом `-wg.conf` при скачивании автоматически добавляется префикс `WG-`.
  - Для файлов с суффиксом `-am.conf` при скачивании автоматически добавляется префикс `AWG-`.

### Изменено

- **Логика генерации имён файлов при скачивании**:
  - Теперь `.conf` и `.ovpn` файлы обрабатываются единообразно: имя клиента + опциональный суффикс `-AZ` для `antizapret`.
  - Обновлена регулярка для корректной работы с доменами, содержащими дефисы.
  - Регулярное выражение перенесено непосредственно в роут для упрощения кода.

### Исправлено

- **Проблемы со скачиванием .conf файлов**:
  - Ранее файлы `.conf` скачивались с полным исходным именем, теперь формируется корректное сокращённое имя клиента, как и для `.ovpn`.

## [1.1.6] - 27-09-2025

### Исправлено

- Переписана логика разбора файлов:
  - Теперь имя клиента определяется более надёжно (через stem и проверку префиксов).
  - Определение типа файла (antizapret / vpn) вынесено в отдельную переменную `kind`.
- Изменён вывод кнопки скачивания: (by [glebsoluyanov](https://github.com/glebsoluyanov))
  - Вместо тега `<a>` с вложенной кнопкой теперь используется один `<button>` с `onclick`.
  - Ссылка на скачивание формируется через `url_for` напрямую.
- Обновлены стили:
  - Значение `padding` у таблицы (`td`) уменьшено с `0.75rem` до `0.5rem`.

## [1.1.5] - 21-06-2025

### Добавлено

- **Веб-интерфейс для конфигурирования Antizapret**:
  - Новый раздел в настройках для управления параметрами маршрутизации
  - 8 переключаемых параметров с подсказками:
    - `ROUTE_ALL` - весь трафик кроме .ru/.рф
    - `DISCORD_INCLUDE` - трафик Discord
    - `CLOUDFLARE_INCLUDE` - трафик Cloudflare
    - `AMAZON_INCLUDE` - трафик Amazon
    - `HETZNER_INCLUDE` - трафик Hetzner
    - `DIGITALOCEAN_INCLUDE` - трафик DigitalOcean
    - `OVH_INCLUDE` - трафик OVH
    - `TELEGRAM_INCLUDE` - трафик Telegram
  - Кнопка сохранения настроек с отображением статуса
  - Интеграция с JavaScript для обработки изменений

### Изменено

- **Структура страницы настроек**:
  - Добавлена новая вкладка "Конфигурирование Antizapret" в боковое меню
  - Оптимизировано расположение элементов управления

### Исправлено

- Исправлено отображение подсказок на мобильных устройствах

## [1.1.4] - 08-05-2025

### Добавлено

- **Интеграция Gunicorn** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Flask теперь работает за полноценным встроенным веб-сервером Gunicorn
  - Gunicorn слушает порт, декодирует SSL-трафик и запускает приложение в 4 потоках по умолчанию
  - Возможность настройки количества воркеров через переменную `GUNICORN_WORKERS` в `.env`
  - Добавлен пункт настройки воркеров на странице изменения порта в веб-интерфейсе

### Исправлено

- **Проблемы с SSL-сертификатами** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Исправлена ошибка при указании существующего, но не привязанного к IP домена
  - Добавлена проверка фактического получения сертификата перед продолжением установки
- **Ошибки в JavaScript** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Исправлено обновление выпадающего списка при удалении клиента в `main_index.js`
  - Удалены неиспользуемые функции `updateConfigTables()` и `updateClientSelect(option)`
- **Обновление client.sh** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Исправлена работа с доменными именами при установке Antizapret
  - Добавлена возможность указать срок действия клиента OpenVPN до 3650 дней
  - Ограничено поле ввода срока действия 4 символами

## [1.1.3] - 26-04-2025

### Добавлено

- **Оптимизированный интерфейс настроек**:
  - Полностью переработанный адаптивный интерфейс страницы настроек
  - Боковое меню с возможностью раскрытия разделов
  - Улучшенное отображение на мобильных устройствах
  - Разделение управления пользователями на вкладки (добавление/список/удаление)

### Исправлено

- **Проблемы с отображением на мобильных устройствах**:
  - Исправлено переполнение текста в меню
  - Оптимизированы размеры элементов для touch-устройств
  - Улучшена прокрутка контента
- **Интерактивность**:
  - Исправлена работа аккордеона в мобильной версии
  - Улучшена реакция на касания

## [1.1.2] - 25-04-2025

### Добавлено

- **Проверка зависимостей при установке** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Добавлена проверка отсутствующих библиотек и утилит (например, `git`, текстовые и сетевые утилиты).
  - Автоматическая установка недостающих зависимостей.
- **Улучшенная проверка портов** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Определение и отображение сервиса, занимающего порт.
  - Проверка наличия перенаправлений в таблице маршрутизации с отображением правил.
- **Изменения в работе с Let's Encrypt** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Таблица маршрутизации временно очищается от 80 TCP порта при получении сертификата, затем восстанавливается.
  - Добавлено предупреждение при попытке использовать стандартные порты 80 и 443 с предложением отключить их резервирование в OpenVPN.
  - Возможность отменить подписку на рассылку Let's Encrypt, оставив поле ввода почты пустым.
  - Установка Let's Encrypt теперь минимальна, без лишних библиотек и заданий в `cron`.
  - Создано собственное задание для обновления сертификатов с временным изменением таблицы маршрутизации и остановкой сервисов, занимающих порт 80.
  - Перезапуск службы AdminAntizapret после обновления сертификатов.

### Исправлено

- **Удаление Let's Encrypt** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Удаление теперь корректно очищает зависимости через `autoremove`.
  - Удаление возможно даже при повторном запуске скрипта, домен берется из сертификата.
  - Удаляются кеши ключей и задания, файл задания остается для ручного использования.
- **Отображение таблиц** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Исправлены проблемы с правой границей таблиц при динамической длине адресов.
- **Функция `press_any_key`** (by [CarolusFuchs](https://github.com/CarolusFuchs)):
  - Теперь корректно реагирует на любую клавишу, а не только на Enter.

### Протестировано

- Протестировано на различных сборках Ubuntu 22.04 и 24.04 (PQ, AEZA, Kyonix, Waicore) (by [CarolusFuchs](https://github.com/CarolusFuchs)).
- Проверены сценарии с занятыми портами и перенаправлениями — все работает корректно.

## [1.1.1] - 20-04-2025

### Добавлено

- **Проверка настроек OpenVPN для HTTPS**:
  - Добавлена автоматическая проверка параметра `OPENVPN_80_443_TCP` в файле `/root/antizapret/setup`
  - Интерактивное предложение изменить значение с `y` на `n` при настройке HTTPS
  - Автоматический перезапуск сервиса antizapret при изменении настроек
- **Улучшенная модульность**:

  - Вынесена проверка OpenVPN в отдельную функцию `check_openvpn_tcp_setting()`
  - Улучшена обработка пользовательского ввода при настройке HTTPS

  ### Изменено

- **Логика выбора портов для HTTPS**:
  - Для всех вариантов HTTPS (Let's Encrypt, собственные сертификаты, самоподписанные) теперь по умолчанию предлагается порт 443
  - Для HTTP сохраняется исходный DEFAULT_PORT (обычно 80)
  - Запрос порта теперь происходит после выбора конкретного типа соединения
- **Улучшения пользовательского интерфейса**:
  - Более логичная последовательность запросов при настройке SSL/TLS
  - Улучшены подсказки при выборе портов

### Исправлено

- Исправлена проверка доступности портов для HTTPS-соединений
- Улучшены сообщения об ошибках при конфликте портов

## [1.1.0] - 19-04-2025

### Архитектурные изменения

- **Полная модуляризация кода**:
  - `backup_functions.sh` — управление резервными копиями
  - `monitoring.sh` — мониторинг ресурсов системы
  - `service_functions.sh` — управление сервисами
  - `ssl_setup.sh` — настройка SSL/TLS сертификатов
  - `uninstall.sh` — полное удаление системы
  - `user_management.sh` — управление пользователями
  - `utils.sh` — вспомогательные утилиты
- **Динамическая загрузка модулей**:
  - Поддержка директории `/opt/AdminAntizapret/script_sh/` для хранения модулей
  - Автоматическое подключение зависимостей
- **Гибкая настройка портов**:
  - Поддержка произвольных портов для HTTP/HTTPS с автоматической проверкой доступности
- **Кастомные домены**:
  - Возможность использования пользовательских доменов и SSL-сертификатов

### Добавлено

- **Система логирования**:
  - Централизованный лог `/var/log/adminpanel.log`
  - Функции `init_logging` и `log` для системного аудита
- **Новые возможности**:
  - Меню **"Мониторинг системы"** (реализовано в `monitoring.sh`)
  - Меню **"Проверить конфигурацию"** (валидация настроек)
- **Безопасная работа сессий**:
  - Автоматическая генерация `SECRET_KEY` при первом запуске:
    - Ключ сохраняется в `.env` для постоянного использования
    - Исключает разлогин пользователей после перезапуска сервиса
    - Гарантирует стабильность сессий при обновлениях системы
- **Безопасность**:
  - Строгая проверка прав root с записью в лог
  - Улучшенная обработка ошибок через `check_error`
- **Автоматическое обновление SSL-сертификатов**:
  - Настроен `cron` для продления сертификатов Let's Encrypt (каждые 60 дней)

### Изменено

- **Локализация**:
  - Переход с `en_US.UTF-8` на `C.UTF-8` для совместимости
- **Зависимости**:
  - Добавлен пакет `cron` в обязательные зависимости
  - Поддержка тихого режима установки (`--quiet`)
- **Проверка AntiZapret**:
  - Детальная проверка через `systemctl`
  - Проверка наличия директории `/root/antizapret`
  - Четкие инструкции при отсутствии модуля

### Улучшения

- **Надежность**:
  - Изоляция компонентов повышает стабильность
  - Автоматическое обновление SSL-сертификатов (каждые 60 дней)
- **Безопасность**:
  - Гарантированное HTTPS-соединение
  - Улучшенная проверка прав доступа
- **Удобство**:
  - Единая точка входа (`/root/AdminPanel/adminpanel.sh`)
  - Подробная документация по модулям
- **Совместимость**:
  - Поддержка различных окружений через `C.UTF-8`
  - Сохранение обратной совместимости

### Примечания

После установки доступны два пути к скрипту:

1. Оригинальное расположение
2. `/root/AdminPanel/adminpanel.sh`

## [1.0.9] - 16-04-2025

### Добавлено

- **Поддержка HTTPS**:

  - Добавлена возможность выбора между Nginx + Let's Encrypt и самоподписанными сертификатами.
  - Автоматическая настройка SSL параметров для Nginx.

- **Улучшенная проверка портов**:
  - Добавлена поддержка нескольких методов проверки занятости портов (ss, netstat, lsof, /proc/net/tcp).
  - Улучшена обработка ошибок при проверке портов.
- **Логирование действий**:
  - Добавлена функция init_logging для записи логов в /var/log/adminpanel.log.
  - Все ключевые действия теперь логируются с временными метками.
- **Мониторинг системы**:
  - Добавлено новое меню мониторинга с возможностью проверки CPU, памяти, диска и сетевых соединений.
- **Валидация конфигурации**:
  - Добавлена функция validate_config для проверки корректности конфигурации.

### Изменено

- Добавлена проверка использования портов 80/443 перед установкой Nginx + Let's Encrypt.
- Улучшена обработка ошибок при установке.
- Добавлена проверка целостности архива после создания резервной копии.
- Включены дополнительные файлы в резервную копию (SSL сертификаты, конфигурации Nginx).
- Улучшена модульность и читаемость кода.
- Добавлены дополнительные проверки ошибок.

### Исправлено

- Улучшена обработка прав доступа к файлам .env и конфигурационным файлам.
- Добавлена валидация доменных имен и проверка DNS записей.

## [1.0.8] - 11-04-2025

### Добавлено

- **Страница настроек**:
  - Возможность изменения порта через веб-интерфейс.
  - Добавление и удаление пользователей.
  - Проверка длины пароля (минимум 8 символов).

## [1.0.7] - 10-04-2025

### Добавлено

- **Мониторинг ресурсов сервера**(by [MagicRaven01](https://github.com/MagicRaven01)):
  - Отображение текущей нагрузки процессора (%)
  - Информация о загруженности диска
  - Время работы сервера (uptime)
  - Кнопки перехода в монитор ресурсов с главной страницы и редактора файлов
  - Реализовано в общей стилистике интерфейса

### Изменено

- **Обновлен роут для скачивания файлов**:
  - Полная поддержка нового формата имен файлов из client.sh
  - Корректная обработка спецсимволов (скобки, дефисы)
  - Автоматическое преобразование имен для скачивания
  - Поддержка обратной совместимости со старыми конфигами
- Оптимизировано расположение элементов навигации
- Обновлены стили для мобильных устройств

## [1.0.6] - 07-04-2025

### Добавлено

- Хранение порта сервиса в `.env` файле (APP_PORT)
- Функция изменения порта через `adminpanel.sh`
- Автоматическое создание `.env` с SECRET_KEY и APP_PORT при установке
- Проверка существующего SECRET_KEY при изменении порта

### Изменено

- Обновлен `adminpanel.sh` для корректной работы с `.env`:
  - Сохранение SECRET_KEY при изменении порта
  - Добавлен пункт меню для изменения порта

## [1.0.5] - 06-04-2025

### Добавлено

- **CSRF-защита** для всех форм (Flask-WTF).
- Автоматическая генерация `SECRET_KEY` при установке и хранение в `.env`.
- Поддержка файла `.env` для конфиденциальных настроек (порт, ключи, БД).
- Добавлен `python-dotenv` в зависимости.
- Блокировка доступа к `.env` через веб-сервер.

### Изменено

- Рефакторинг `app.py` для работы с переменными окружения.
- Обновлён `adminpanel.sh` для создания `.env` и настройки прав.

## [1.0.4] - 05-04-2025

### Изменено

- Возвращена функция удаления клиента в `adminpanel.sh`.
- Исправлена выдача прав на файлы.
- Клиенты теперь отображаются в таблице в алфавитном порядке (by [CarolusFuchs](https://github.com/CarolusFuchs)).
- Откорректированы масштабы модального окна QR для правильного отображения на мобильных устройствах и мониторах (by [CarolusFuchs](https://github.com/CarolusFuchs)).
- Откорректирована высота ячеек клиентов WG и Amneziya (теперь совпадает с OpenVPN) (by [CarolusFuchs](https://github.com/CarolusFuchs)).
- Проверка существования файла в роутах app.py вынесена в отдельный декоратор (оптимизация кода) (by [CarolusFuchs](https://github.com/CarolusFuchs)).

## [1.0.3] - 03-04-2025

### Добавлено

- Добавлена генерация QR-кодов для конфигурационных файлов Amnezia и WireGuard (by [CarolusFuchs](https://github.com/CarolusFuchs)).
- Добавлена функция удаления администратора с предварительным выводом списка администраторов в `adminpanel.sh`.
- Добавлена поддержка аргумента `--list-users` в `init_db.py` для вывода списка пользователей.
- Добавлена проверка на пустой ввод при удалении администратора.
- Обновлен client.sh до последней версии убрана ошибка с удаление конфигураций OpenVPN

### Изменено

- Обновлено главное меню в `adminpanel.sh` для включения нового пункта "Удалить администратора".
- Улучшена обработка ошибок при удалении администратора.

## [1.0.2] - 02-04-2025

### Исправлено

- Исправлен ввод имени файла с использованием символа `-` и ограничением имени в 15 символов.
- Добавлено скачивание конфигурации с коротким именем (by [CarolusFuchs](https://github.com/CarolusFuchs)).
- Рефакторинг: введен конфиг-объект, устранено дублирование кода, вынесены константы для сроков сертификатов. (by [MagicRaven01](https://github.com/MagicRaven01))

## [1.0.1] - 03-2025

### Добавлено

- Поддержка WireGuard.
- Функционал редактирования файлов конфигурации AntiZapret через веб-интерфейс.
- Авторизация с использованием SQLite и Flask-SQLAlchemy.
- Стилизация интерфейса с использованием CSS и адаптивного дизайна.
- Скрипты для проверки обновлений и перезапуска сервиса.
- Скрипт `adminpanel.sh` для установки, управления и удаления AdminAntizapret.

## [1.0.0] - 03-2025

### Добавлено

- Веб-приложение на Flask для управления VPN-клиентами.
- Поддержка OpenVPN и AmneziaWG.
- Возможность добавления, удаления и скачивания конфигурационных файлов клиентов.
- Панель управления через веб-интерфейс.
- Система резервного копирования и восстановления данных.

---
